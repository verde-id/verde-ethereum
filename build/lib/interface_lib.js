'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.idpInterface = exports.rpInterface = exports.ethereumInterface = undefined;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

let getRequests = (() => {
  var _ref = (0, _asyncToGenerator3.default)(function* (userId) {
    let userAddress = yield findUserAddress('cid', userId);
    return idpContract.getRequests(userAddress);
  });

  return function getRequests(_x) {
    return _ref.apply(this, arguments);
  };
})();

var _index = require('../index');

var _index2 = _interopRequireDefault(_index);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const RPC_HOST = 'localhost'; // import web3 from 'web3';

const RPC_PORT = '8545';
const REQUESTS_CONTRACT_ADDR = process.env.REQUESTS_CONTRACT_ADDR;
const DIRECTORY_CONTRACT_ADDR = process.env.DIRECTORY_CONTRACT_ADDR;
const IDP_ADDR = process.env.IDP_ADDR;
const RP_ADDR = process.env.RP_ADDR;

var idpContract, rpContract, directoryContract;

if (!IDP_ADDR && !RP_ADDR) {
  throw 'Must specify RP_ADDR or IDP_ADDR';
}

//contract instance
if (IDP_ADDR) idpContract = (0, _index2.default)(RPC_HOST, RPC_PORT, REQUESTS_CONTRACT_ADDR, IDP_ADDR);

if (RP_ADDR) rpContract = (0, _index2.default)(RPC_HOST, RPC_PORT, REQUESTS_CONTRACT_ADDR, RP_ADDR);

if (DIRECTORY_CONTRACT_ADDR) {
  directoryContract = (0, _index2.default)(RPC_HOST, RPC_PORT, false, IDP_ADDR, {
    directoryAddress: DIRECTORY_CONTRACT_ADDR
  });
}

/*
 * Create a request.
 * Parameters
 *  requestObject: object
 *    userId : string
 *    requestText : string
 *    idpRequestList: array of integer 
 * Returns
 *  requestID : string
*/

function createRequest({ userAddress, requestText }) {
  //should return request id
  return rpContract.createRequest(userAddress, requestText, 0);
}

function addIdpResponse({ requestId, code }) {
  idpContract.addIdpResponse(requestId, code, 'Mock up message');
}

/* 
 * Parameters
 *   Function
 *     
 * Example
 *   watchRequestEvent(function(error, result)) {
 *     if (!error)
 *       console.log(result)
 *     else
 *       console.error(error);
 */

function watchRequestEvent(callback) {
  idpContract.watchRequestEvent(function (error, eventObject) {
    if (error) return callback(error);
    //filter only for those event concern IDP_ADDR
    callback(null, eventObject.args);
  });
}

function watchIDPResponseEvent(callback) {
  rpContract.watchIdpResponse(function (error, eventObject) {
    if (error) return callback(error);
    //filter only for those event concern RP_ADDR
    callback(null, eventObject.args);
  });
}

function watchAuthenticationEvent(requestId, callback) {
  rpContract.watchAuthenticationEvent(requestId, function (error, eventObject) {
    if (error) return callback(error);
    //filter only for those event concern RP_ADDR
    callback(null, eventObject.args);
  });
}

function createUser(namespace, id) {
  return directoryContract.createUser(IDP_ADDR, namespace, id);
}

function findUserAddress(namespace, id) {
  return directoryContract.findUserAddress(namespace, id);
}

function setMinimumIdpForUser(userAddress, newValue) {
  return idpContract.setMinimumResponse(userAddress, newValue);
}

const ethereumInterface = exports.ethereumInterface = {
  createRequest,
  watchRequestEvent,
  watchIDPResponseEvent,
  watchAuthenticationEvent,
  getRequests,
  addIdpResponse,
  createUser,
  findUserAddress
};

const rpInterface = exports.rpInterface = {
  createRequest,
  watchIDPResponseEvent,
  watchAuthenticationEvent,
  findUserAddress
};

const idpInterface = exports.idpInterface = {
  watchRequestEvent,
  getRequests,
  addIdpResponse,
  createUser,
  findUserAddress,
  setMinimumIdpForUser
};

exports.default = ethereumInterface;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9pbnRlcmZhY2VfbGliLmpzIl0sIm5hbWVzIjpbInVzZXJJZCIsInVzZXJBZGRyZXNzIiwiZmluZFVzZXJBZGRyZXNzIiwiaWRwQ29udHJhY3QiLCJnZXRSZXF1ZXN0cyIsIlJQQ19IT1NUIiwiUlBDX1BPUlQiLCJSRVFVRVNUU19DT05UUkFDVF9BRERSIiwicHJvY2VzcyIsImVudiIsIkRJUkVDVE9SWV9DT05UUkFDVF9BRERSIiwiSURQX0FERFIiLCJSUF9BRERSIiwicnBDb250cmFjdCIsImRpcmVjdG9yeUNvbnRyYWN0IiwiZGlyZWN0b3J5QWRkcmVzcyIsImNyZWF0ZVJlcXVlc3QiLCJyZXF1ZXN0VGV4dCIsImFkZElkcFJlc3BvbnNlIiwicmVxdWVzdElkIiwiY29kZSIsIndhdGNoUmVxdWVzdEV2ZW50IiwiY2FsbGJhY2siLCJlcnJvciIsImV2ZW50T2JqZWN0IiwiYXJncyIsIndhdGNoSURQUmVzcG9uc2VFdmVudCIsIndhdGNoSWRwUmVzcG9uc2UiLCJ3YXRjaEF1dGhlbnRpY2F0aW9uRXZlbnQiLCJjcmVhdGVVc2VyIiwibmFtZXNwYWNlIiwiaWQiLCJzZXRNaW5pbXVtSWRwRm9yVXNlciIsIm5ld1ZhbHVlIiwic2V0TWluaW11bVJlc3BvbnNlIiwiZXRoZXJldW1JbnRlcmZhY2UiLCJycEludGVyZmFjZSIsImlkcEludGVyZmFjZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OzZDQXFGQSxXQUEyQkEsTUFBM0IsRUFBbUM7QUFDakMsUUFBSUMsY0FBYyxNQUFNQyxnQkFBZ0IsS0FBaEIsRUFBdUJGLE1BQXZCLENBQXhCO0FBQ0EsV0FBT0csWUFBWUMsV0FBWixDQUF3QkgsV0FBeEIsQ0FBUDtBQUNELEc7O2tCQUhjRyxXOzs7OztBQXBGZjs7Ozs7O0FBRUEsTUFBTUMsV0FBVyxXQUFqQixDLENBSEE7O0FBSUEsTUFBTUMsV0FBVyxNQUFqQjtBQUNBLE1BQU1DLHlCQUF5QkMsUUFBUUMsR0FBUixDQUFZRixzQkFBM0M7QUFD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QUMvQm5CLGVBRCtCO0FBRS9CSyxtQkFGK0I7QUFHL0JLLHVCQUgrQjtBQUkvQkUsMEJBSitCO0FBSy9CeEIsYUFMK0I7QUFNL0JjLGdCQU4rQjtBQU8vQlcsWUFQK0I7QUFRL0IzQjtBQVIrQixDQUExQjs7QUFXQSxNQUFNa0Msb0NBQWM7QUFDekJwQixlQUR5QjtBQUV6QlUsdUJBRnlCO0FBR3pCRSwwQkFIeUI7QUFJekIxQjtBQUp5QixDQUFwQjs7QUFPQSxNQUFNbUMsc0NBQWU7QUFDMUJoQixtQkFEMEI7QUFFMUJqQixhQUYwQjtBQUcxQmMsZ0JBSDBCO0FBSTFCVyxZQUowQjtBQUsxQjNCLGlCQUwwQjtBQU0xQjhCO0FBTjBCLENBQXJCOztrQkFTUUcsaUIiLCJmaWxlIjoiaW50ZXJmYWNlX2xpYi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGltcG9ydCB3ZWIzIGZyb20gJ3dlYjMnO1xuaW1wb3J0IGV0aGVyZXVtIGZyb20gJy4uL2luZGV4JztcblxuY29uc3QgUlBDX0hPU1QgPSAnbG9jYWxob3N0JztcbmNvbnN0IFJQQ19QT1JUID0gJzg1NDUnO1xuY29uc3QgUkVRVUVTVFNfQ09OVFJBQ1RfQUREUiA9IHByb2Nlc3MuZW52LlJFUVVFU1RTX0NPTlRSQUNUX0FERFI7XG5jb25zdCBESVJFQ1RPUllfQ09OVFJBQ1RfQUREUiA9IHByb2Nlc3MuZW52LkRJUkVDVE9SWV9DT05UUkFDVF9BRERSO1xuY29uc3QgSURQX0FERFIgPSBwcm9jZXNzLmVudi5JRFBfQUREUjtcbmNvbnN0IFJQX0FERFIgPSBwcm9jZXNzLmVudi5SUF9BRERSO1xuXG52YXIgaWRwQ29udHJhY3QsIHJwQ29udHJhY3QsIGRpcmVjdG9yeUNvbnRyYWN0O1xuXG5pZiAoIUlEUF9BRERSICYmICFSUF9BRERSKSB7XG4gIHRocm93ICdNdXN0IHNwZWNpZnkgUlBfQUREUiBvciBJRFBfQUREUic7XG59XG5cbi8vY29udHJhY3QgaW5zdGFuY2VcbmlmIChJRFBfQUREUilcbiAgaWRwQ29udHJhY3QgPSBldGhlcmV1bShSUENfSE9TVCwgUlBDX1BPUlQsIFJFUVVFU1RTX0NPTlRSQUNUX0FERFIsIElEUF9BRERSKTtcblxuaWYgKFJQX0FERFIpXG4gIHJwQ29udHJhY3QgPSBldGhlcmV1bShSUENfSE9TVCwgUlBDX1BPUlQsIFJFUVVFU1RTX0NPTlRSQUNUX0FERFIsIFJQX0FERFIpO1xuXG5pZiAoRElSRUNUT1JZX0NPTlRSQUNUX0FERFIpIHtcbiAgZGlyZWN0b3J5Q29udHJhY3QgPSBldGhlcmV1bShSUENfSE9TVCwgUlBDX1BPUlQsIGZhbHNlLCBJRFBfQUREUiwge1xuICAgIGRpcmVjdG9yeUFkZHJlc3M6IERJUkVDVE9SWV9DT05UUkFDVF9BRERSXG4gIH0pO1xufVxuXG4vKlxuICogQ3JlYXRlIGEgcmVxdWVzdC5cbiAqIFBhcmFtZXRlcnNcbiAqICByZXF1ZXN0T2JqZWN0OiBvYmplY3RcbiAqICAgIHVzZXJJZCA6IHN0cmluZ1xuICogICAgcmVxdWVzdFRleHQgOiBzdHJpbmdcbiAqICAgIGlkcFJlcXVlc3RMaXN0OiBhcnJheSBvZiBpbnRlZ2VyIFxuICogUmV0dXJuc1xuICogIHJlcXVlc3RJRCA6IHN0cmluZ1xuKi9cblxuZnVuY3Rpb24gY3JlYXRlUmVxdWVzdCh7IHVzZXJBZGRyZXNzLCByZXF1ZXN0VGV4dCB9KSB7XG4gIC8vc2hvdWxkIHJldHVybiByZXF1ZXN0IGlkXG4gIHJldHVybiBycENvbnRyYWN0LmNyZWF0ZVJlcXVlc3QodXNlckFkZHJlc3MsIHJlcXVlc3RUZXh0LCAwKTtcbn1cblxuZnVuY3Rpb24gYWRkSWRwUmVzcG9uc2UoeyByZXF1ZXN0SWQsIGNvZGUgfSkge1xuICBpZHBDb250cmFjdC5hZGRJZHBSZXNwb25zZShyZXF1ZXN0SWQsIGNvZGUsICdNb2NrIHVwIG1lc3NhZ2UnKTtcbn1cblxuLyogXG4gKiBQYXJhbWV0ZXJzXG4gKiAgIEZ1bmN0aW9uXG4gKiAgICAgXG4gKiBFeGFtcGxlXG4gKiAgIHdhdGNoUmVxdWVzdEV2ZW50KGZ1bmN0aW9uKGVycm9yLCByZXN1bHQpKSB7XG4gKiAgICAgaWYgKCFlcnJvcilcbiAqICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdClcbiAqICAgICBlbHNlXG4gKiAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAqL1xuXG5mdW5jdGlvbiB3YXRjaFJlcXVlc3RFdmVudChjYWxsYmFjaykge1xuICBpZHBDb250cmFjdC53YXRjaFJlcXVlc3RFdmVudChmdW5jdGlvbihlcnJvciwgZXZlbnRPYmplY3QpIHtcbiAgICBpZiAoZXJyb3IpIHJldHVybiBjYWxsYmFjayhlcnJvcik7XG4gICAgLy9maWx0ZXIgb25seSBmb3IgdGhvc2UgZXZlbnQgY29uY2VybiBJRFBfQUREUlxuICAgIGNhbGxiYWNrKG51bGwsIGV2ZW50T2JqZWN0LmFyZ3MpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gd2F0Y2hJRFBSZXNwb25zZUV2ZW50KGNhbGxiYWNrKSB7XG4gIHJwQ29udHJhY3Qud2F0Y2hJZHBSZXNwb25zZShmdW5jdGlvbihlcnJvciwgZXZlbnRPYmplY3QpIHtcbiAgICBpZiAoZXJyb3IpIHJldHVybiBjYWxsYmFjayhlcnJvcik7XG4gICAgLy9maWx0ZXIgb25seSBmb3IgdGhvc2UgZXZlbnQgY29uY2VybiBSUF9BRERSXG4gICAgY2FsbGJhY2sobnVsbCwgZXZlbnRPYmplY3QuYXJncyk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiB3YXRjaEF1dGhlbnRpY2F0aW9uRXZlbnQocmVxdWVzdElkLCBjYWxsYmFjaykge1xuICBycENvbnRyYWN0LndhdGNoQXV0aGVudGljYXRpb25FdmVudChyZXF1ZXN0SWQsIGZ1bmN0aW9uKGVycm9yLCBldmVudE9iamVjdCkge1xuICAgIGlmIChlcnJvcikgcmV0dXJuIGNhbGxiYWNrKGVycm9yKTtcbiAgICAvL2ZpbHRlciBvbmx5IGZvciB0aG9zZSBldmVudCBjb25jZXJuIFJQX0FERFJcbiAgICBjYWxsYmFjayhudWxsLCBldmVudE9iamVjdC5hcmdzKTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlcXVlc3RzKHVzZXJJZCkge1xuICBsZXQgdXNlckFkZHJlc3MgPSBhd2FpdCBmaW5kVXNlckFkZHJlc3MoJ2NpZCcsIHVzZXJJZCk7XG4gIHJldHVybiBpZHBDb250cmFjdC5nZXRSZXF1ZXN0cyh1c2VyQWRkcmVzcyk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVVzZXIobmFtZXNwYWNlLCBpZCkge1xuICByZXR1cm4gZGlyZWN0b3J5Q29udHJhY3QuY3JlYXRlVXNlcihJRFBfQUREUiwgbmFtZXNwYWNlLCBpZCk7XG59XG5cbmZ1bmN0aW9uIGZpbmRVc2VyQWRkcmVzcyhuYW1lc3BhY2UsIGlkKSB7XG4gIHJldHVybiBkaXJlY3RvcnlDb250cmFjdC5maW5kVXNlckFkZHJlc3MobmFtZXNwYWNlLCBpZCk7XG59XG5cbmZ1bmN0aW9uIHNldE1pbmltdW1JZHBGb3JVc2VyKHVzZXJBZGRyZXNzLCBuZXdWYWx1ZSkge1xuICByZXR1cm4gaWRwQ29udHJhY3Quc2V0TWluaW11bVJlc3BvbnNlKHVzZXJBZGRyZXNzLCBuZXdWYWx1ZSk7XG59XG5cbmV4cG9ydCBjb25zdCBldGhlcmV1bUludGVyZmFjZSA9IHtcbiAgY3JlYXRlUmVxdWVzdCxcbiAgd2F0Y2hSZXF1ZXN0RXZlbnQsXG4gIHdhdGNoSURQUmVzcG9uc2VFdmVudCxcbiAgd2F0Y2hBdXRoZW50aWNhdGlvbkV2ZW50LFxuICBnZXRSZXF1ZXN0cyxcbiAgYWRkSWRwUmVzcG9uc2UsXG4gIGNyZWF0ZVVzZXIsXG4gIGZpbmRVc2VyQWRkcmVzc1xufTtcblxuZXhwb3J0IGNvbnN0IHJwSW50ZXJmYWNlID0ge1xuICBjcmVhdGVSZXF1ZXN0LFxuICB3YXRjaElEUFJlc3BvbnNlRXZlbnQsXG4gIHdhdGNoQXV0aGVudGljYXRpb25FdmVudCxcbiAgZmluZFVzZXJBZGRyZXNzXG59O1xuXG5leHBvcnQgY29uc3QgaWRwSW50ZXJmYWNlID0ge1xuICB3YXRjaFJlcXVlc3RFdmVudCxcbiAgZ2V0UmVxdWVzdHMsXG4gIGFkZElkcFJlc3BvbnNlLFxuICBjcmVhdGVVc2VyLFxuICBmaW5kVXNlckFkZHJlc3MsXG4gIHNldE1pbmltdW1JZHBGb3JVc2VyXG59O1xuXG5leHBvcnQgZGVmYXVsdCBldGhlcmV1bUludGVyZmFjZTtcbiJdfQ==